# Chat History System - Visual Flow

## ğŸ“Š Storage Logic Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Sends Message                            â”‚
â”‚  { email, session_id, message }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Determine Time Block                                â”‚
â”‚  Current Hour < 12? â†’ Block 1 : Block 2                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Check if Record Exists                                   â”‚
â”‚  WHERE email = ? AND session_id = ?                             â”‚
â”‚    AND chat_date = TODAY AND time_block = ?                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                   â”‚
            EXISTS  â”‚                   â”‚  NOT EXISTS
                    â–¼                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  UPDATE Record   â”‚  â”‚  CREATE Record   â”‚
        â”‚                  â”‚  â”‚                  â”‚
        â”‚ Append Q&A to    â”‚  â”‚ New record with  â”‚
        â”‚ JSONB array      â”‚  â”‚ first Q&A        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“… Timeline Example

```
User: john@example.com
Session: session_001

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Day 1 (2025-12-23)

â”Œâ”€â”€ 09:00 â”€â”€â”  Message: "Hello"
â”‚  Block 1  â”‚  Action: CREATE Record #1
â”‚ (Morning) â”‚  history: [{"q":"Hello", "a":"Hi", "ts":"09:00"}]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€ 10:30 â”€â”€â”  Message: "Find table"
â”‚  Block 1  â”‚  Action: UPDATE Record #1 (same block!)
â”‚ (Morning) â”‚  history: [
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    {"q":"Hello", "a":"Hi", "ts":"09:00"},
                 {"q":"Find table", "a":"Here...", "ts":"10:30"}
                ]

â”Œâ”€â”€ 11:45 â”€â”€â”  Message: "What price?"
â”‚  Block 1  â”‚  Action: UPDATE Record #1 (still same block)
â”‚ (Morning) â”‚  history: [
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    {"q":"Hello", "a":"Hi", "ts":"09:00"},
                 {"q":"Find table", "a":"Here...", "ts":"10:30"},
                 {"q":"What price?", "a":"$500", "ts":"11:45"}
                ]

â”â”â”â”â” 12:00 PM - TIME BLOCK CHANGES â”â”â”â”â”

â”Œâ”€â”€ 14:00 â”€â”€â”  Message: "Thank you"
â”‚  Block 2  â”‚  Action: CREATE Record #2 (new block!)
â”‚(Afternoon)â”‚  history: [{"q":"Thank you", "a":"Welcome", "ts":"14:00"}]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€ 15:30 â”€â”€â”  Message: "Goodbye"
â”‚  Block 2  â”‚  Action: UPDATE Record #2 (same block)
â”‚(Afternoon)â”‚  history: [
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    {"q":"Thank you", "a":"Welcome", "ts":"14:00"},
                 {"q":"Goodbye", "a":"Bye!", "ts":"15:30"}
                ]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Day 2 (2025-12-24)

â”Œâ”€â”€ 08:00 â”€â”€â”  Message: "Good morning"
â”‚  Block 1  â”‚  Action: CREATE Record #3 (new day!)
â”‚ (Morning) â”‚  history: [{"q":"Good morning", "a":"Hi", "ts":"08:00"}]
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Database State:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Record #1: 2025-12-23, Block 1 â†’ 3 messages                â”‚
â”‚ Record #2: 2025-12-23, Block 2 â†’ 2 messages                â”‚
â”‚ Record #3: 2025-12-24, Block 1 â†’ 1 message                 â”‚
â”‚                                                             â”‚
â”‚ Total: 3 records, 6 messages                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ—ƒï¸ Database Table Structure

```
chat_histories
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      id      â”‚    email     â”‚ session_id  â”‚ chat_date  â”‚ time_block â”‚         history          â”‚
â”‚    (UUID)    â”‚    (TEXT)    â”‚   (TEXT)    â”‚   (DATE)   â”‚  (1 or 2)  â”‚         (JSONB)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ abc-123...   â”‚ john@x.com   â”‚ session_001 â”‚ 2025-12-23 â”‚     1      â”‚ [{"q":"...", "a":"..."}] â”‚
â”‚ def-456...   â”‚ john@x.com   â”‚ session_001 â”‚ 2025-12-23 â”‚     2      â”‚ [{"q":"...", "a":"..."}] â”‚
â”‚ ghi-789...   â”‚ john@x.com   â”‚ session_001 â”‚ 2025-12-24 â”‚     1      â”‚ [{"q":"...", "a":"..."}] â”‚
â”‚ jkl-012...   â”‚ mary@x.com   â”‚ session_002 â”‚ 2025-12-23 â”‚     1      â”‚ [{"q":"...", "a":"..."}] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

UNIQUE KEY: (email, session_id, chat_date, time_block)
```

## ğŸ”„ API Request/Response Flow

### Request: Send Chat
```http
POST /chat HTTP/1.1
Content-Type: application/json

{
  "email": "john@example.com",
  "session_id": "session_001",
  "message": "TÃ¬m bÃ n gá»—",
  "context": {}
}

â†“

Response:
{
  "response": "TÃ¬m tháº¥y 10 sáº£n pháº©m...",
  "products": [...],
  "suggested_prompts": [...]
}

AND

Database saves to:
âœ… Old table: chat_history (for backward compatibility)
âœ… New table: chat_histories (with time block logic)
```

### Request: Get History
```http
GET /chat-history/john@example.com/session_001 HTTP/1.1

â†“

Response:
{
  "email": "john@example.com",
  "session_id": "session_001",
  "total_records": 3,    â† 3 database records
  "total_chats": 15,     â† 15 total Q&A pairs
  "chats": [
    {
      "question": "...",
      "answer": "...",
      "timestamp": "2025-12-23T09:00:00",
      "date": "2025-12-23",
      "time_block": 1
    },
    ...
  ]
}
```

## ğŸ’¾ JSONB Structure

```json
{
  "history": [
    {
      "q": "User question text",
      "a": "Bot answer text",
      "timestamp": "2025-12-23T10:30:45.123456"
    },
    {
      "q": "Another question",
      "a": "Another answer",
      "timestamp": "2025-12-23T10:35:20.789012"
    }
  ]
}
```

## ğŸ¯ Key Decision Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Message Arrives       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ What Hour?   â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
      â”‚             â”‚
   < 12h         â‰¥ 12h
      â”‚             â”‚
  Block 1       Block 2
      â”‚             â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Record Exists?     â”‚
  â”‚ (email + session + â”‚
  â”‚  date + block)     â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
        â”‚        â”‚
      YES       NO
        â”‚        â”‚
     UPDATE   CREATE
```

## ğŸ“ˆ Benefits Visualization

```
Traditional (One row per message):
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ Row â”‚ Row â”‚ Row â”‚ Row â”‚ Row â”‚ Row â”‚ Row â”‚ Row â”‚  â† 1000 messages = 1000 rows
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
âŒ Many rows
âŒ Slow to retrieve full conversation
âŒ More storage overhead

New System (JSONB grouping):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Morning Block   â”‚ Afternoon Block â”‚ Next Day Block  â”‚  â† 1000 messages â‰ˆ 10-50 rows
â”‚ (many messages) â”‚ (many messages) â”‚ (many messages) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
âœ… Fewer rows
âœ… Fast retrieval
âœ… Efficient storage
âœ… Natural time grouping
```

## ğŸ¨ UI Display Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Chat History: john@example.com / session_001      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  ğŸ“… December 23, 2025 - Morning                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  09:00 ğŸ‘¤ Hello                                    â”‚
â”‚  09:01 ğŸ¤– Hi! How can I help?                      â”‚
â”‚                                                     â”‚
â”‚  10:30 ğŸ‘¤ Find table                               â”‚
â”‚  10:31 ğŸ¤– Here are 10 tables...                    â”‚
â”‚                                                     â”‚
â”‚  ğŸ“… December 23, 2025 - Afternoon                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  14:00 ğŸ‘¤ Thank you                                â”‚
â”‚  14:01 ğŸ¤– You're welcome!                          â”‚
â”‚                                                     â”‚
â”‚  ğŸ“… December 24, 2025 - Morning                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚  08:00 ğŸ‘¤ Good morning                             â”‚
â”‚  08:01 ğŸ¤– Good morning! Back again?                â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

This visual guide helps understand:
- ğŸ”„ How messages flow through the system
- ğŸ“Š How data is stored and grouped
- â° When new records are created vs updated
- ğŸ¯ Decision logic for time blocks
- ğŸ“ˆ Benefits over traditional storage
